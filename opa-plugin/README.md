# OPA Plugin

## Configuration

| Configuration      | Description                                                    | Usage                                                                                                                                                            |
|--------------------|----------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `policy-templates` | A directory where Rego policies are located.                   | The are Rego policies defined by the users. The policies can include data variables that are generated by the plugin defined in the compliance as code language. |
| `policy-output`    | A directory to write OPA configuration data in JSON for checks | If a `data.json` is created, it will be written here and all selected or in-scope policies are copied here for use or bundling.                                  |
| `policy-results`   | A directory where OPA results are located.                     | Results of an `opa eval` run are provided her by the user.                                                                                                       |
| `bundle`           | A location for an opa policy bundle.                           | Set this field if you want the plugin to build a policy bundle with all of you check policies. If unset, it will not create a bundle                             |
| `bundle-revision`  | A revision for the produced bundle                             | The default is 1.0. Only set this is if `bundle` is set.                                                                                                         |


### Example Rego policy

To use the plugin, there are fields in the `rego` policy required.

Below is an example:
```rego
package branch_protection

# Required top level field
default pass := false

pass if {
	pull_request_rule_meets_min_approvals
}

has_pull_request_rule if {
	input.values
	some i
	input.values[i].type == "pull_request"
}

pull_request_rule_meets_min_approvals if {
	some i
	rule = input.values[i]
	rule.type == "pull_request"
	# The below value is provided by the data.json input generated by the plugin
	required_count := data.main_branch_min_approvals
	rule.parameters.required_approving_review_count >= required_count
}

# Required attributes
evaluation_resource_id := input.id
evaluation_resource_name := input.name
evaluation_resource_type := "resource"
policy_id := "github-branch-protection"

## Violations required if there are specific pre-condition checks
violation[msg] if {
	not input.values
	msg = "No branch protection rules found in the input 'values' array."
}

violation[msg] if {
	input.values
	not has_pull_request_rule
	msg = "No 'pull_request' rule found for the main branch in the input's 'values' array."
}

violation[msg] if {
	required_count := data.main_branch_min_approvals
	not pull_request_rule_meets_min_approvals
	msg = sprintf("Branch protection for 'main' requires pull request reviews but has less than the configured minimum of %v required approving reviews.", [required_count])
}
```

## Build locally

To use locally, you can run `make build` and create a plugin manifest.

```bash
make build
checksum=$(sha256sum "$(go env GOPATH)/bin/opa-plugin" | cut -d ' ' -f 1 )
    cat >  "$(go env GOPATH)/bin/c2p-opa-manifest.json" << EOF
    {
      "metadata": {
        "id": "opa",
        "description": "OPA PVP Plugin",
        "version": "0.0.1",
        "types": [
          "pvp"
        ]
      },
      "executablePath": "opa-plugin",
      "sha256": "$checksum",
      "configuration": [
        {
          "name": "policy-templates",
          "description": "A directory where Rego policies are located.",
          "required": true
        },
        {
          "name": "policy-output",
          "description": "A directory to write OPA configuration data in JSON for checks.",
          "required": true,
        },
        {
          "name": "policy-results",
          "description": "A directory where OPA results are located.",
          "required": true
        },
        {
          "name": "bundle",
          "description": "A location for an opa policy bundle. If unset, no bundle is created.",
          "required": false
        },
        {
          "name": "bundle-revision",
          "description": "A bundle revision if a bundle is created.",
          "required": false,
          "default": "1.0"
        }
      ]
    }
    EOF
```